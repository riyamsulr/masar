<!DOCTYPE html>
<html lang="ar" dir="rtl">
<?php
require 'connection.php';

// نقرأ معرف الكويز بأمان
$qID = isset($_GET['quizID']) ? (int)$_GET['quizID'] : 0;
if ($qID <= 0) { header('Location: Learner.php'); exit; }
?>
<head>
  <meta charset="UTF-8" />
  <title>الاختبار — إشارات المرور</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="common.css">
  <link rel="icon" href="images/logo.png">
  <style>
    .quiz-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .link-group{display:flex;gap:16px;flex-wrap:wrap}
    .quiz-meta{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .meta-box{background:#fff;border:1px solid #D6CEC2;border-radius:12px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .meta-box strong{display:block;font-size:13px;color:#8A8A8B;margin-bottom:4px}
    .col-num{width:44px;text-align:center}
    .q-title{font-weight:700}
    .submit-button-div{padding-top:2rem;display:flex;justify-content:center}
  </style>
</head>

<body>
  <!-- الهيدر -->
  <header>
    <div class="header-container">
      <div class="logo">
        <img src="images/logo.png" alt="شعار الموقع">
        <span>مسار لتدريب القيادة</span>
      </div>
    </div>
  </header>

  <div class="container">

    <!-- العنوان -->
    <div class="quiz-header">
      <h1 class="section-title"><span class="accent"></span> الاختبار — إشارات المرور</h1>
      <div class="link-group">
        <a href="Learner.php" class="hl-link">رجوع</a>
      </div>
    </div>

    <!-- معلومات عامة -->
    <div class="quiz-meta">
      <?php
        // عدد أسئلة هذا الكويز
        $countQuery   = "SELECT COUNT(*) AS total FROM quizquestion WHERE quizID = {$qID}";
        $countResult  = mysqli_query($connection, $countQuery);
        $countRow     = mysqli_fetch_assoc($countResult);
        $questionCount= (int)($countRow['total'] ?? 0);
        $displayCount = ($questionCount >= 5) ? 5 : $questionCount;

        // موضوع الكويز واسم المعلم
        $quizInfo = "SELECT u.firstName, u.lastName, t.topicName
                     FROM quiz q
                     JOIN user  u ON q.educatorID = u.id
                     JOIN topic t ON q.topicID    = t.id
                     WHERE q.id = {$qID}";
        if ($result = mysqli_query($connection,$quizInfo)){
          if ($row = mysqli_fetch_assoc($result)){
            echo '<div class="meta-box"><strong>الموضوع</strong><div>'.htmlspecialchars($row['topicName']).'</div></div>';
            echo '<div class="meta-box"><strong>المعلّم</strong><div>'.htmlspecialchars($row['firstName'].' '.$row['lastName']).'</div></div>';
            echo '<div class="meta-box"><strong>إجمالي الأسئلة</strong><div>'.$displayCount.'</div></div>';
          }
        }
      ?>
    </div>

    <!-- الأسئلة -->
    <form action="quiz-score.php" method="POST">
      <input type="hidden" name="quizID" value="<?php echo (int)$qID; ?>">

      <section class="section">
        <div class="card table-card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="col-num">#</th>
                  <th>السؤال والخيارات</th>
                </tr>
              </thead>
              <tbody>
                <?php
                  // نعرض 5 أسئلة عشوائية كحد أقصى
                  $randquestions = ($questionCount <= 5)
                    ? "SELECT * FROM quizquestion WHERE quizID={$qID} ORDER BY RAND()"
                    : "SELECT * FROM quizquestion WHERE quizID={$qID} ORDER BY RAND() LIMIT 5";

                  if ($result = mysqli_query($connection, $randquestions)) {
                    $questionNum = 1;
                    while ($row = mysqli_fetch_assoc($result)) {
                      $qid   = (int)$row['id'];
                      $qtext = $row['question'] ?? '';
                      $a = $row['answerA'] ?? '';
                      $b = $row['answerB'] ?? '';
                      $c = $row['answerC'] ?? '';
                      $d = $row['answerD'] ?? '';

                      echo '<tr id="q'.$questionNum.'">';
                      echo '<td>'.$questionNum.'</td>';
                      echo '<td>';

                      // مهم: نرسل معرف السؤال
                      echo '<input type="hidden" name="questionIDs[]" value="'.$qid.'">';

                      echo '<div class="q-item has-media">';

                      // صورة السؤال (اختياري)
                      if (!empty($row['questionFigureFileName'])) {
                        $img = htmlspecialchars($row['questionFigureFileName']);
                        echo '<div class="q-media tall"><img class="q-img" src="'.$img.'" loading="lazy" decoding="async"></div>';
                      }

                      echo '<div class="q-body">';
                      echo '<div class="q-title">'.htmlspecialchars($qtext).'</div>';
                      echo '<ol class="choices">';

                      // ✳️ الاسم الصحيح للمجموعة: answers[QID]
                      $name = 'answers['.$qid.']';

                      // ✳️ القيم الصحيحة: A/B/C/D
                      echo '<li><label><input type="radio" name="'.$name.'" value="A" required> '.htmlspecialchars($a).'</label></li>';
                      echo '<li><label><input type="radio" name="'.$name.'" value="B"> '.htmlspecialchars($b).'</label></li>';
                      echo '<li><label><input type="radio" name="'.$name.'" value="C"> '.htmlspecialchars($c).'</label></li>';
                      echo '<li><label><input type="radio" name="'.$name.'" value="D"> '.htmlspecialchars($d).'</label></li>';

                      echo '</ol></div></div></td></tr>';
                      $questionNum++;
                    }
                  } else {
                    echo '<tr><td colspan="2">لا توجد أسئلة لهذا الاختبار.</td></tr>';
                  }
                ?>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <div class="submit-button-div">
        <button type="submit" class="btn primary btn-full" style="height:3rem;">إرسال الإجابات</button>
      </div>
    </form>

  </div>

  <footer>&copy; 2025 جميع الحقوق محفوظة</footer>
</body>
</html>
